// https://github.com/klocatelli/reddit-message-search-bookmarklet
(function(i){var m=i(".content[role=main]"),d=i("ul.tabmenu"),r=i('<div class="content" role="main" />'),v=i('<div class="searchpane raisedbox" />'),w=i('<a href="javascript:void(0)">(close search)</a>'),x=i('<h4 style="color:gray">search messages </h4>'),b=i('<form method="post" id="search" role="search" />'),k=i('<input type="text" name="q" placeholder="search query" />'),s=i('<div class="siteTable" class="sitetable linklisting" />'),l=i('<p id="noresults" class="error" />'),n=i('<a class="prevLink" rel="prev">‹ prev</a>'),p=i('<a class="nextLink" rel="next">next ›</a>'),h=i('<span class="separator"></span>'),e=i('<p class="nextprev"></p>'),c=1000;e.append(n);e.append(h);e.append(p);n.hide();p.hide();h.hide();w.click(function(){j()});b.submit(function(z){z.preventDefault();var y=i(this).find("input[name=q]").val();if(!y){alert("Enter a search query")}else{a(y)}});b.append(k);x.append(w);v.append(x);v.append(b);r.append(v);r.append(s);r.append(l);r.append(e);r.insertAfter(m);m.hide();d.hide();function q(y){l.text(y||"")}function o(){q();s.empty();p.hide();p.unbind();n.hide();n.unbind();h.hide()}function g(){o();q("Loading...")}function a(z,y){g();y=y||{};y.limit=c;i.getJSON("/message/messages.json",y,function(A){q();f(z,A)}).error(function(){q("Error getting search results (check that you're logged in and reddit isn't under heavy load)")})}function f(A,z){var y=[];z=z.data;console.log(z);console.log(A);if(z.after){p.show();p.click(function(){a(A,{after:z.after})})}if(z.before){n.show();n.click(function(){a(A,{before:z.before})})}if(z.after&&z.before){h.show()}i.each(z.children,function(B,C){C=C.data;if(u(A,C)){y.push(C)}i.each(C.replies.data.children,function(D,E){E=E.data;if(u(A,E)){y.push(E)}})});if(y.length){y.sort(function(C,B){return B.created_utc-C.created_utc});i.each(y,function(B,C){t(C,B)})}else{q("No results in this block of "+c+" threads")}}function u(B,z){var A=(z.subject+z.body).toLowerCase(),y=B.toLowerCase();return A.indexOf(y)>-1}function t(D,y){var z=i('<div class="thing message" />'),A=i('<p class="subject" />'),C=i('<div class="entry unvoted" />'),F=i('<div class="noncollapsed" />'),B=i('<p class="tagline" />'),E=i('<div class="clearleft" />');z.addClass(y%2?"odd":"even");z.addClass("id-"+D.name);z.click(click_thing(z));z.attr("data-fullname",D.name);A.text(D.subject);B.append('<span class="head">to <b>'+D.author+"</b></span>");F.append(B);F.append(i("<div/>").html(D.body_html).text());F.append('<ul class="flat-list buttons"><li class="first"><a href="http://www.reddit.com/message/messages/'+D.id+'" class="bylink" rel="nofollow">permalink</a>');C.append(F);z.append(A);z.append(C);z.append(E);s.append(z)}function j(){r.remove();d.show();m.show()}})(jQuery);